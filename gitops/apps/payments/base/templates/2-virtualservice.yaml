apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ .Chart.Name }}-vsvc
  namespace: {{ .Values.namespace | default "demo" }}
spec:
  hosts:
    - "{{ .Values.istio.host | default "api.travelersources.com" }}"
  gateways:
    - "{{ .Values.istio.gateway | default "api-gateway" }}"
  http:

    # Canary route
    - name: {{ .Chart.Name }}-canary-debug
      match:
        - uri:
            prefix: "/payments/"
          headers:
            x-canary:
              exact: "true"
        - uri:
            prefix: "/payments"
          headers:
            x-canary:
              exact: "true"
      route:
        - destination:
            host: {{ .Chart.Name }}-canary
            port:
              number: {{ .Values.service.httpPort | default 3004 }}
          weight: 100
      # corsPolicy:
      #   allowOrigins:
      #     - exact: "{{ .Values.frontendUrl }}"
      #   allowMethods: ["GET","POST","PUT","DELETE","OPTIONS"]
      #   allowHeaders: ["*"]
      #   allowCredentials: true
      #   maxAge: "1h"

    # Stable route
    - name: primary
      match:
        - uri:
            prefix: "/payments/"
        - uri:
            exact: "/payments"
        - uri:
            prefix: "/payments"
        - uri:
            exact: "/payments"
      route:
        - destination:
            host: {{ .Chart.Name }}-stable
            port:
              number: {{ .Values.service.httpPort | default 3004 }}
          weight: 100
        - destination:
            host: {{ .Chart.Name }}-canary
            port:
              number: {{ .Values.service.httpPort | default 3004 }}
          weight: 0
      # corsPolicy:
      #   allowOrigins:
      #     - exact: "{{ .Values.frontendUrl }}"
      #   allowMethods: ["GET","POST","PUT","DELETE","OPTIONS"]
      #   allowHeaders: ["*"]
      #   allowCredentials: true
      #   maxAge: "1h"
